name: 'reth-kona-stack'

services:
  # ==========================================
  # Op-Reth (Optimism Execution Client)
  # ==========================================
  op-reth:
    restart: unless-stopped
    # Set tag via OP_RETH_TAG environment variable (default: latest)
    image: ${OP_RETH_IMAGE:-ghcr.io/paradigmxyz/op-reth}:${OP_RETH_TAG:-latest}
    container_name: reth
    ports:
      - "${OP_RETH_METRICS_PORT:-9001}:9001"     # metrics
      - "${OP_RETH_DISCOVERY_PORT:-30303}:30303/tcp"  # discovery
      - "${OP_RETH_DISCOVERY_PORT:-30303}:30303/udp"  # discovery
      - "${OP_RETH_RPC_PORT:-8545}:8545"         # rpc
      - "${OP_RETH_ENGINE_PORT:-8551}:8551"      # engine
    volumes:
      - op_reth_data:/db
      - op_reth_logs:/root/logs
      - ./jwttoken:/root/jwt:ro
    environment:
      RUST_LOG: ${OP_RETH_RUST_LOG:-info}
    command: >
      node
      --datadir /db
      --chain ${OP_RETH_CHAIN:-optimism-sepolia}
      --rollup.sequencer-http ${OP_RETH_SEQUENCER_HTTP:-https://sepolia-sequencer.optimism.io/}
      --metrics 0.0.0.0:9001
      --log.file.directory /root/logs
      --authrpc.addr 0.0.0.0
      --authrpc.port 8551
      --authrpc.jwtsecret /root/jwt/jwt.hex
      --http --http.addr 0.0.0.0 --http.port 8545
      --http.api "eth,net,web3,debug,trace"
    networks:
      - reth-kona-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Kona Node (Consensus Client)
  # ==========================================
  kona-node:
    restart: unless-stopped
    # Set tag via KONA_TAG environment variable (default: latest)
    image: ${KONA_IMAGE:-ghcr.io/op-rs/kona/kona-node}:${KONA_TAG:-latest}
    container_name: kona
    depends_on:
      op-reth:
        condition: service_started
    ports:
      - "${KONA_DISCOVERY_PORT:-9223}:9223/tcp"  # discovery
      - "${KONA_DISCOVERY_PORT:-9223}:9223/udp"  # discovery
      - "${KONA_METRICS_PORT:-9002}:9002"        # metrics
      - "${KONA_RPC_PORT:-5060}:5060"            # rpc
    volumes:
      - kona_data:/db
      - ./jwttoken:/root/jwt:ro
    environment:
      L1_PROVIDER_RPC: ${L1_PROVIDER_RPC:?L1_PROVIDER_RPC must be set}
      L1_BEACON_API: ${L1_BEACON_API:?L1_BEACON_API must be set}
      RUST_LOG: ${KONA_RUST_LOG:-info}
    command: >
      --chain ${KONA_CHAIN:-optimism-sepolia}
      --metrics.enabled
      --metrics.port 9002
      node
      --l1 $L1_PROVIDER_RPC
      --l1-beacon $L1_BEACON_API
      --l2 http://op-reth:8551
      --l2-engine-jwt-secret /root/jwt/jwt.hex
      --rpc.port 5060
      --p2p.listen.tcp 9223
      --p2p.listen.udp 9223
      --p2p.bootstore /db
    networks:
      - reth-kona-network

  # ==========================================
  # Monitoring Stack
  # ==========================================
  prometheus:
    restart: unless-stopped
    image: prom/prometheus:${PROMETHEUS_TAG:-latest}
    container_name: reth-kona-prometheus
    ports:
      - "${PROMETHEUS_PORT:-9091}:9090"
    volumes:
      - prometheus_data:/prometheus
      - ./prometheus:/etc/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    networks:
      - reth-kona-network

  grafana:
    restart: unless-stopped
    image: grafana/grafana:${GRAFANA_TAG:-latest}
    container_name: reth-kona-grafana
    depends_on:
      - prometheus
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      PROMETHEUS_URL: ${PROMETHEUS_URL:-http://prometheus:9090}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
    networks:
      - reth-kona-network

networks:
  reth-kona-network:
    driver: bridge

volumes:
  op_reth_data:
    driver: local
  op_reth_logs:
    driver: local
  kona_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

